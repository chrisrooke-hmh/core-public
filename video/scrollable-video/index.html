<html>
    <head>
        <title>Scrollable video</title>
        <style>
            body {
                border: 0;
                padding: 0;
                margin: 0;
                /* height: 1000vh; */
            }

            video {
                margin: 0;
                width: 100%;
                height: 100vh;
                object-fit: cover;
                position: fixed;
            }

            .question {
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: white;
                padding: 32px;
                width: fit-content;
                max-width: 80%;
                border-radius: 16px;
                display: flex;
                justify-content: center;
                flex-wrap: wrap;
                visibility: hidden;
                opacity: 0;
                transition: opacity .2s ease-in-out;
            }

            .question.visible {
                visibility: visible;
                opacity: 1;
            }

            h2 {
                font-size: 48px;
                text-align: center;
                flex-basis: 100%;
                margin: 0 0 16px 0;
            }

            button {
                border-radius: 8px;
                background: grey;
                padding: 16px;
                font-size: 24px;
                color: white;
                border: 0;
                cursor: pointer;
                margin: 16px;
            }

            .correct {
                background-color: darkolivegreen;
            }

            .incorrect {
                background-color: darkred;
            }

            @keyframes headShake {
            0% {
                transform: translateX(0);
            }

            6.5% {
                transform: translateX(-6px) rotateY(-9deg);
            }

            18.5% {
                transform: translateX(5px) rotateY(7deg);
            }

            31.5% {
                transform: translateX(-3px) rotateY(-5deg);
            }

            43.5% {
                transform: translateX(2px) rotateY(3deg);
            }

            50% {
                transform: translateX(0);
            }
            }

            .headShake {
            animation-timing-function: ease-in-out;
            animation-name: headShake;
            animation-duration: 1s;
            }

            .preventScroll {
                overflow: hidden;
            }

            article {
                width: 100%;
                position: relative;
                opacity: 0;
                transition: opacity .2s ease-in-out;
                /* display: flex;
                justify-content: center;
                align-items: center; */
                text-shadow: 0 0 10px rgba(0,0,0,0.4);
            }

            article.active {
                opacity: 1;
            }

            article.past {
                opacity: 0;
            }

            article:before {
                /* content: ''; */
                position: absolute;
                top: 0;
                left: 0;
                bottom: 0;
                right: 0;
                background: pink; 
                opacity: 0.25;
            }

            article.active h1 {
                animation: fadeInUp 1s ease-out forwards;
            }

            article.active p {
                opacity: 0;
                transform: translate3d(0, 100%, 0);
                animation: fadeInUp 1s 1s ease-out forwards;
            }

            div {
                position: sticky;
                top: 50vh;
                transform: translateY(-50%);
                margin: 0 auto;
                width: fit-content;
                text-align: center;
                font-family: sans-serif, system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
                color: white;
            }

            h1 {
                font-size: 5vw;
                margin: 0;
                /* opacity: 0; */
                /* transform: translate3d(0, 100%, 0); */
                /* transition: opacity .2s ease-in-out; */
            }

            p {
                font-size: 2.5vw;
                font-weight: 700;
                margin: 0;
                /* opacity: 0; */
                /* transform: translate3d(0, 100%, 0);
                transition: opacity .2s ease-in-out; */
            }

            @keyframes fadeInUp {
                from {
                    opacity: 0;
                    transform: translate3d(0, 100%, 0);
                }

                to {
                    opacity: 1;
                    transform: translate3d(0, 0, 0);
                }
            }

        </style>
    </head>
    <body id="body">
        <video id="vid" autobuffer="autobuffer" preload="auto" muted>
            <!-- <source src="Chrome_ImF.webm" type="video/webm"></source> -->
            <source src="video.webm" type="video/webm"></source>
            <!-- <source src="video-sm.webm" type="video/webm"></source> -->
            <source src="video.mp4" type="video/mp4"></source>
        </video>

        <!-- <article id="q1">
            <h2>
                What is in this video?
            </h2>
            <button id="correct">
                A galaxy close to home
            </button>
            <button id="incorrect">
                A galaxy far, far away
            </button>
        </article> -->

        <script>
            var frameNumber = 0, // start video at frame 0
                // lower numbers = faster playback
                playbackConst = 1000, 
                // get page height from video duration
                setHeight = document.getElementById("body"), 
                // select video element         
                vid = document.getElementById('vid'), 
                body = document.getElementById('body');

            // dynamically set the page height according to video length
            vid.addEventListener('loadedmetadata', function() {
            setHeight.style.height = Math.floor(vid.duration) * playbackConst + "px";
            });


            // Use requestAnimationFrame for smooth playback
            function scrollPlay(){  
                frameNumber  = window.pageYOffset/playbackConst;
                vid.currentTime  = frameNumber;
                window.requestAnimationFrame(scrollPlay);
                // console.log(window.pageYOffset, vid.currentTime);
            }

            const zones = [
                {
                    startTime: 2,
                    endTime: 5,
                    type: 'text',
                    contents: '<h1>Welcome to the Milky Way</h1><p>Discover our galaxy</p>'
                }
            ]

            window.onload = function() {
                let panels = [];
                
                for (i=0; i<zones.length; i++) {
                    const panelEl = document.createElement("article");
                    panelEl.setAttribute('id',`q${i}`);
                    panelEl.style.height = ((zones[i].endTime - zones[i].startTime) / Math.floor(vid.duration)) * (Math.floor(vid.duration) * playbackConst) + 'px';
                    panelEl.style.top = (zones[i].startTime / Math.floor(vid.duration)) * (Math.floor(vid.duration) * playbackConst) + 'px';
                    panelEl.innerHTML = '<div>' + zones[i].contents + '</div>';
                    document.body.appendChild(panelEl);
                    panels.push(`q${i}`);
                } 

                document.addEventListener( 'scroll', event => {
                    for (j=0; j<panels.length; j++) {
                        if(inViewport(document.getElementById(panels[j])) === 'active'){
                            document.getElementById(panels[j]).classList.add('active');
                            document.getElementById(panels[j]).classList.remove('past');
                        } else if (inViewport(document.getElementById(panels[j])) === 'past') {
                            document.getElementById(panels[j]).classList.add('past');
                        } else if (inViewport(document.getElementById(panels[j])) === 'early') {
                            document.getElementById(panels[j]).classList.remove('active');
                        }
                    }
                })

                // for (j=0; j<panels.length; j++) {
                //     document.getElementById(panels[j])
                // }
            }

            function inViewport( element ){
                // Get the elements position relative to the viewport
                var bb = element.getBoundingClientRect();
                // Check if the element is outside the viewport
                // Then invert the returned value because you want to know the opposite
                // return !(bb.top > innerHeight || bb.bottom < 0);
                if (bb.top > 0) {
                    return 'early';
                }
                if (bb.top <= 0 && bb.bottom >= innerHeight) {
                    return 'active';
                } else if (bb.top <= 0 && bb.bottom >= 0) {
                    return 'past';
                } else {
                    return false;
                };
            }

            var myElement = document.querySelector( 'div' );

            // Listen for the scroll event

            // document.addEventListener( 'scroll', event => {
            // // Check the viewport status
            // if( inViewport( myElement ) ){
            //     myElement.style.background = 'red';
            // } else {
            //     myElement.style.background = '';
            // }
            // })





            // OLD: set question gates 
            const questions = [
                // {
                //     vidPosition: 5,
                //     title: 'What is in this video?',
                //     answers: ['The Milky Way', 'A galaxy far, far away', 'A galaxy closer to home', 'A marble'
                // ]
                // },
                // {
                //     vidPosition: 8,
                //     title: 'Second question',
                //     answers: [ 'Correct', 'Incorrect 1', 'Incorrect 2'
                // ]
                // },
                // {
                //     vidPosition: 11,
                //     title: 'Third question',
                //     answers: ['Correct', 'Incorrect 1', 'Incorrect 2', 'Incorrect 3', 'Incorrect 4'
                // ]
                // }
            ]

            // let questionTimes = [];
            // let nextStop, nextStopIndex;
            // window.onload = function() {
            //     // console.log(questions.length);
            //     for (let i = 0; i < questions.length; i++ ) {
            //         // Create question El
            //         const panelEl = document.createElement("article");
            //         const questionEl  = document.createElement("h2");
            //         questionEl.appendChild(document.createTextNode(questions[i].title)); 
            //         panelEl.appendChild(questionEl);
            //         panelEl.setAttribute('id',`q${i}`);
            //         panelEl.setAttribute('data-index', i);
            //         panelEl.classList.add('question');
            //         var answersArr = questions[i].answers;
            //         console.log(answersArr);
            //         for (var j = 0; j < answersArr.length; j++) {
            //             const buttonEl = document.createElement("button");
            //             buttonEl.appendChild(document.createTextNode(answersArr[j]));
            //             if (j === 0) {
            //                 buttonEl.classList.add('correct');
            //             } else {
            //                 buttonEl.classList.add('incorrect');
            //             }
            //             panelEl.appendChild(buttonEl);
            //         }
            //         document.body.appendChild(panelEl);
            //         questionTimes.push(questions[i].vidPosition);
            //     }

            //     nextStop = Math.min(...questionTimes);
            //     nextStopIndex = questionTimes.indexOf(nextStop);

            //     correctButtons = document.getElementsByClassName('correct');
            //     for (var k = 0; k < correctButtons.length; k++) {
            //         correctButtons[k].addEventListener('click', function() {
            //             let currentIndex = this.parentElement.getAttribute('data-index');
            //             this.parentElement.classList.remove('visible');
            //             body.classList.remove('preventScroll');
            //             nextStopIndex++;
            //             nextStop = questionTimes[nextStopIndex];
            //             console.log(nextStopIndex); 
            //         });
            //     }

            //     incorrectButtons = document.getElementsByClassName('incorrect');
            //     for (var l = 0; l < incorrectButtons.length; l++) {
            //         incorrectButtons[l].addEventListener('click', function() {
            //             this.classList.add('headShake');
            //         });
            //     }
            // }

            // window.addEventListener('scroll', function(e) {
            //     // console.log(frameNumber);
            //     if (frameNumber >= nextStop) {
            //         body.classList.add('preventScroll');
            //         let currentQuestion = document.getElementById(`q${nextStopIndex}`);
            //         currentQuestion.classList.add('visible');
            //     }
            // });
            window.requestAnimationFrame(scrollPlay);
        
        </script>
    </body>
</html>