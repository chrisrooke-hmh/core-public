<html>
    <head>
        <title>Scrollable video</title>
        <style>
            body {
                border: 0;
                padding: 0;
                margin: 0;
                /* height: 1000vh; */
            }

            video {
                margin: 0;
                width: 100%;
                height: 100vh;
                object-fit: cover;
                position: fixed;
            }

            .question {
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: white;
                padding: 32px;
                width: fit-content;
                max-width: 80%;
                border-radius: 16px;
                display: flex;
                justify-content: center;
                flex-wrap: wrap;
                visibility: hidden;
                opacity: 0;
                transition: opacity .2s ease-in-out;
            }

            .question.visible {
                visibility: visible;
                opacity: 1;
            }

            h2 {
                font-size: 48px;
                text-align: center;
                flex-basis: 100%;
                margin: 0 0 16px 0;
            }

            button {
                border-radius: 8px;
                background: grey;
                padding: 16px;
                font-size: 24px;
                color: white;
                border: 0;
                cursor: pointer;
                margin: 16px;
            }

            .correct {
                background-color: darkolivegreen;
            }

            .incorrect {
                background-color: darkred;
            }

            @keyframes headShake {
            0% {
                transform: translateX(0);
            }

            6.5% {
                transform: translateX(-6px) rotateY(-9deg);
            }

            18.5% {
                transform: translateX(5px) rotateY(7deg);
            }

            31.5% {
                transform: translateX(-3px) rotateY(-5deg);
            }

            43.5% {
                transform: translateX(2px) rotateY(3deg);
            }

            50% {
                transform: translateX(0);
            }
            }

            .headShake {
            animation-timing-function: ease-in-out;
            animation-name: headShake;
            animation-duration: 1s;
            }

            .preventScroll {
                overflow: hidden;
            }

            section {
                width: 100%;
                position: absolute;
                opacity: 0;
                transition: opacity .2s ease-in-out;
                /* display: flex;
                justify-content: center;
                align-items: center; */
                text-shadow: 0 0 10px rgba(0,0,0,0.4);
            }

            section.active {
                opacity: 1;
            }

            section.past {
                opacity: 0;
            }

            section:before {
                /* content: ''; */
                position: absolute;
                top: 0;
                left: 0;
                bottom: 0;
                right: 0;
                background: pink; 
                opacity: 0.25;
            }

            section.active h1, section.active article {
                animation: fadeInUp 1s ease-out forwards;
            }

            section.active div > p {
                opacity: 0;
                transform: translate3d(0, 100%, 0);
                animation: fadeInUp 1s 1s ease-out forwards;
            }

            div {
                position: sticky;
                top: 50vh;
                transform: translateY(-50%);
                margin: 0 auto;
                width: fit-content;
                text-align: center;
                font-family: sans-serif, system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
                color: white;
            }

            h1 {
                font-size: 5vw;
                margin: 0;
                /* opacity: 0; */
                /* transform: translate3d(0, 100%, 0); */
                /* transition: opacity .2s ease-in-out; */
            }

            div > p {
                font-size: 2.5vw;
                font-weight: 700;
                margin: 0;
                /* opacity: 0; */
                /* transform: translate3d(0, 100%, 0);
                transition: opacity .2s ease-in-out; */
            }

            article {
                width: 50vw;
                background: white;
                color: rgba(0,0,0,0.87);
                text-align: left;
                text-shadow: 0;
                padding: 32px;
                border-radius: 16px;
            }

            article p {
                font-size: 20px;
            }

            article p:first-child {
                font-size: 24px;
            }

            details > summary {
                list-style: none;
            }

            details summary::-webkit-details-marker {
                display:none;
            }

            details {
                display: flex;
                align-items: center;
                align-content: center;
            }

            summary {
                width: 30px;
                height: 30px;
                border-radius: 50%;
                border: 2px solid white;
                background: pink;
                position: absolute;
                overflow: hidden;
                left: 50%;
                top: 50%;
                transform: translate(-50%, -50%);
                cursor: pointer;
            }



            @keyframes fadeInUp {
                from {
                    opacity: 0;
                    transform: translate3d(0, 100%, 0);
                }

                to {
                    opacity: 1;
                    transform: translate3d(0, 0, 0);
                }
            }

        </style>
    </head>
    <body id="body">
        <video id="vid" autobuffer="autobuffer" preload="auto" muted>
            <!-- <source src="Chrome_ImF.webm" type="video/webm"></source> -->
            <!-- <source src="video.webm" type="video/webm"></source> -->
            <!-- <source src="video-sm.webm" type="video/webm"></source> -->
            <source src="video-sm_timecode.mp4" type="video/mp4"></source>
        </video>

        <!-- <article id="q1">
            <h2>
                What is in this video?
            </h2>
            <button id="correct">
                A galaxy close to home
            </button>
            <button id="incorrect">
                A galaxy far, far away
            </button>
        </article> -->

        <script>
            var frameNumber = 0, // start video at frame 0
                // lower numbers = faster playback
                playbackConst = 1000, 
                // get page height from video duration
                setHeight = document.getElementById("body"), 
                // select video element         
                vid = document.getElementById('vid'), 
                body = document.getElementById('body');

            // dynamically set the page height according to video length
            vid.addEventListener('loadedmetadata', function() {
                // console.log(vid.duration);
                setHeight.style.height = Math.floor(vid.duration) * playbackConst + "px";
            });


            // Use requestAnimationFrame for smooth playback
            function scrollPlay(){  
                frameNumber  = window.pageYOffset/playbackConst;
                vid.currentTime  = frameNumber;
                window.requestAnimationFrame(scrollPlay);
                // console.log(window.pageYOffset, vid.currentTime);
            }

            const zones = [
                {
                    startTime: 2,
                    endTime: 5,
                    type: 'text',
                    contents: '<h1>Welcome to the Milky Way</h1><p>Discover our galaxy</p>'
                },
                {
                    startTime: 7,
                    endTime: 10,
                    type: 'panel',
                    contents: '<p>The Milky Way is the galaxy that includes our Solar System, with the name describing the galaxy\'s appearance from Earth: a hazy band of light seen in the night sky formed from stars that cannot be individually distinguished by the naked eye</p><p>The Milky Way as a whole is moving at a velocity of approximately 600 km per second with respect to extragalactic frames of reference. The oldest stars in the Milky Way are nearly as old as the Universe itself and thus probably formed shortly after the Dark Ages of the Big Bang.</p>'
                },
                {
                    startTime: 12,
                    endTime: 15,
                    type: 'gate',
                    contents: '<p>This panel is a gate.</p><p>Some sort of conditional activity should go here.</p>'
                },
                {
                    startTime: 17,
                    endTime: 20,
                    type: 'hotspot',
                    contents: '<p>This panel is a gate.</p><p>Some sort of conditional activity should go here.</p>'
                }


            ]

            window.onload = function() {
                let panels = [];
                
                for (i=0; i<zones.length; i++) {
                    const panelEl = document.createElement("section");
                    panelEl.setAttribute('id',`q${i}`);
                    panelEl.classList.add(zones[i].type);
                    panelEl.style.height = ((zones[i].endTime + 1 - zones[i].startTime) / Math.floor(vid.duration)) * (Math.floor(vid.duration) * playbackConst) + 'px';
                    panelEl.style.top = (zones[i].startTime / Math.floor(vid.duration)) * (Math.floor(vid.duration) * playbackConst) + 'px';
                    if (zones[i].type === 'text') {
                        panelEl.innerHTML = '<div>' + zones[i].contents + '</div>';
                    } else if (zones[i].type === 'panel') {
                        panelEl.innerHTML = '<div><article>' + zones[i].contents + '</article></div>';
                    } else if (zones[i].type === 'gate') {
                        panelEl.innerHTML = '<div><article>' + zones[i].contents + '<button class="close">Close</button></article></div>';
                    } else if (zones[i].type === 'hotspot') {
                        panelEl.innerHTML = '<div><details><summary></summary><article>' + zones[i].contents + '<button class="close-details">Close</button></article></details>';
                    }
                    document.body.appendChild(panelEl);
                    panels.push(`q${i}`);
                } 
                // console.log(panels);

                document.addEventListener( 'scroll', event => {
                    for (j=0; j<panels.length; j++) {
                        if(inViewport(document.getElementById(panels[j])) === 'active'){
                            document.getElementById(panels[j]).classList.add('active');
                            if (!document.getElementById(panels[j]).classList.contains('gate')) {
                                document.getElementById(panels[j]).classList.remove('past');
                            }
                            if (document.getElementById(panels[j]).classList.contains('gate') && !document.getElementById(panels[j]).classList.contains('past')) {
                                body.classList.add('preventScroll');
                            }
                        } else if (inViewport(document.getElementById(panels[j])) === 'past') {
                            document.getElementById(panels[j]).classList.add('past');
                        } else if (inViewport(document.getElementById(panels[j])) === 'early') {
                            document.getElementById(panels[j]).classList.remove('active');
                        }
                    }
                })

                // for (j=0; j<panels.length; j++) {
                //     document.getElementById(panels[j])
                // }

                let closers = document.getElementsByClassName('close');
                for (k=0; k<closers.length; k++) {
                    // console.log(closers[k].parentElement.closest('section'));
                    closers[k].onclick = () => {
                        body.classList.remove('preventScroll');
                        // console.log(event.target.parentElement.closest('section'));

                        event.target.parentElement.closest('section').classList.remove('active');
                        event.target.parentElement.closest('section').classList.add('past');
                    }
                }

                let detailsClosers = document.getElementsByClassName('close-details');
                for (l=0; l<detailsClosers.length; l++) {
                    // console.log(closers[k].parentElement.closest('section'));
                    detailsClosers[l].onclick = () => {
                        body.classList.remove('preventScroll');
                        console.log(event.target.parentElement.closest('details'));
                        event.target.parentElement.closest('details').removeAttribute("open");
                    }
                }

                let summaries = document.getElementsByTagName('summary');
                for (m=0; m<summaries.length; m++) {
                    // console.log(closers[k].parentElement.closest('section'));
                    summaries[m].onclick = () => {
                        body.classList.add('preventScroll');
                        // console.log(event.target.parentElement.closest('section'));
                    }
                }


            }



            function inViewport( element ){
                // Get the elements position relative to the viewport
                var bb = element.getBoundingClientRect();
                // Check if the element is outside the viewport
                // Then invert the returned value because you want to know the opposite
                // return !(bb.top > innerHeight || bb.bottom < 0);
                if (bb.top > 0) {
                    return 'early';
                }
                if (bb.top <= 0 && bb.bottom >= innerHeight) {
                    return 'active';
                } else if (bb.top <= 0 && bb.bottom >= 0) {
                    return 'past';
                } else {
                    return false;
                };
            }

            var myElement = document.querySelector( 'div' );


            // OLD: set question gates 
            const questions = [
                // {
                //     vidPosition: 5,
                //     title: 'What is in this video?',
                //     answers: ['The Milky Way', 'A galaxy far, far away', 'A galaxy closer to home', 'A marble'
                // ]
                // },
                // {
                //     vidPosition: 8,
                //     title: 'Second question',
                //     answers: [ 'Correct', 'Incorrect 1', 'Incorrect 2'
                // ]
                // },
                // {
                //     vidPosition: 11,
                //     title: 'Third question',
                //     answers: ['Correct', 'Incorrect 1', 'Incorrect 2', 'Incorrect 3', 'Incorrect 4'
                // ]
                // }
            ]

            // let questionTimes = [];
            // let nextStop, nextStopIndex;
            // window.onload = function() {
            //     // console.log(questions.length);
            //     for (let i = 0; i < questions.length; i++ ) {
            //         // Create question El
            //         const panelEl = document.createElement("article");
            //         const questionEl  = document.createElement("h2");
            //         questionEl.appendChild(document.createTextNode(questions[i].title)); 
            //         panelEl.appendChild(questionEl);
            //         panelEl.setAttribute('id',`q${i}`);
            //         panelEl.setAttribute('data-index', i);
            //         panelEl.classList.add('question');
            //         var answersArr = questions[i].answers;
            //         console.log(answersArr);
            //         for (var j = 0; j < answersArr.length; j++) {
            //             const buttonEl = document.createElement("button");
            //             buttonEl.appendChild(document.createTextNode(answersArr[j]));
            //             if (j === 0) {
            //                 buttonEl.classList.add('correct');
            //             } else {
            //                 buttonEl.classList.add('incorrect');
            //             }
            //             panelEl.appendChild(buttonEl);
            //         }
            //         document.body.appendChild(panelEl);
            //         questionTimes.push(questions[i].vidPosition);
            //     }

            //     nextStop = Math.min(...questionTimes);
            //     nextStopIndex = questionTimes.indexOf(nextStop);

            //     correctButtons = document.getElementsByClassName('correct');
            //     for (var k = 0; k < correctButtons.length; k++) {
            //         correctButtons[k].addEventListener('click', function() {
            //             let currentIndex = this.parentElement.getAttribute('data-index');
            //             this.parentElement.classList.remove('visible');
            //             body.classList.remove('preventScroll');
            //             nextStopIndex++;
            //             nextStop = questionTimes[nextStopIndex];
            //             console.log(nextStopIndex); 
            //         });
            //     }

            //     incorrectButtons = document.getElementsByClassName('incorrect');
            //     for (var l = 0; l < incorrectButtons.length; l++) {
            //         incorrectButtons[l].addEventListener('click', function() {
            //             this.classList.add('headShake');
            //         });
            //     }
            // }

            // window.addEventListener('scroll', function(e) {
            //     // console.log(frameNumber);
            //     if (frameNumber >= nextStop) {
            //         body.classList.add('preventScroll');
            //         let currentQuestion = document.getElementById(`q${nextStopIndex}`);
            //         currentQuestion.classList.add('visible');
            //     }
            // });
            window.requestAnimationFrame(scrollPlay);
        
        </script>
    </body>
</html>